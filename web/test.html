<!DOCTYPE html>
<html><head>
<title>mnm - [{.Title}]</title>
</head><body>

<style>
.pre { font-family:monospace; white-space:pre-wrap; }
</style>

<div>
<a target="mnm_web" href="/web/service.html">web file</a>
<form method="POST" action="/t/+trial" enctype="multipart/form-data" style="display:inline!important">
  <input type="file" name="filename">
  <input type="submit" value="upload"></form>
<form method="POST" action="/t/-trial" style="display:inline!important">
  <input type="submit" value="drop"></form>
<a target="mnm_upload" href="/t/trial">download</a>
<a target="mnm_upload" href="/t/">list</a>
</div>

<p><div>
Blank Forms
<form method="POST" action="/f/+trial" enctype="multipart/form-data" style="display:inline!important">
  <input type="hidden" name="filename" value='{"key":"value"}'>
  <input type="submit" value="upload"></form>
<form method="POST" action="/f/*trial+2nd" style="display:inline!important">
  <input type="submit" value="duplicate"></form>
<form method="POST" action="/f/-trial.original" style="display:inline!important">
  <input type="submit" value="drop"></form>
<a target="mnm_upload" href="/f/trial.original">download</a>
<a target="mnm_upload" href="/f/">list</a>
</div></p>

<button onclick="mnm._SvcAdd()">Add Service</button>
<button onclick="mnm._PingSave()">Ping</button>
<button onclick="mnm._PingSave('group[{.Addr}]')">Invite</button>
<button onclick="mnm._OhiAdd()">Add Ohi</button>
<button onclick="mnm._OhiDrop()">Drop Ohi</button>

<table border="1">
<tr><td>services </td><td class="pre" id="get?sl">.</td></tr>
<tr><td>config   </td><td class="pre" id="get?cf">.</td></tr>
<tr><td>ohi from </td><td class="pre" id="get?of">.</td></tr>
<tr><td>ohi to   </td><td class="pre" id="get?ot">.</td></tr>
<tr><td>pingdraft</td><td class="pre" id="get?ps">.</td></tr>
<tr><td>pingto   </td><td class="pre" id="get?pt">.</td></tr>
<tr><td>pingfrom </td><td class="pre" id="get?pf">.</td></tr>
<tr><td>inviteto </td><td class="pre" id="get?it">.</td></tr>
<tr><td>invitefrm</td><td class="pre" id="get?if">.</td></tr>
<tr><td>groups   </td><td class="pre" id="get?gl">.</td></tr>
</table><br/>

<button onclick="mnm.History(-1)">Back</button>
<button onclick="mnm.History(1)">Next</button>
<button onclick="mnm._ThreadNew()">New Thread</button>
<button onclick="mnm.ThreadRecv()">Receive Msg</button>

<table border="1">
<tr><td>svc tabs </td><td class="pre" id="get?cs">.</td></tr>
<tr><td>threads  </td><td class="pre" id="get?tl">.</td></tr>
<tr><td>attached </td><td class="pre" id="get?al">.</td></tr>
<tr><td>tabs     </td><td class="pre" id="get?ct">.</td></tr>
<tr><td>msg index</td><td class="pre" id="get?ml">.</td></tr>
<tr><td>last msg </td><td class="pre" id="get?mn">.</td></tr>
<tr><td>open msgs</td><td class="pre" id="get?mo">.</td></tr>
</table>

<div id="msg"></div>

<script src="/web/socket.js"></script>
<script>
;
(function() {
  mnm.Log = function(i) {
    var aLog = document.getElementById('msg').innerText;
    document.getElementById('msg').innerText = i+' '+aLog;
  };

  mnm.Render = function(i, iData, iMap) {
    switch (i) {
    case 'ps': fDrawPing    (JSON.parse(iData)); break;
    case 'if': fDrawInvite  (JSON.parse(iData)); break;
    case 'tl': fDrawThreads (JSON.parse(iData)); break;
    case 'al': fDrawAttached(JSON.parse(iData)); break;
    case 'cs': fDrawTabs    (JSON.parse(iData)); break;
    case 'ml': fDrawMsgIndex(JSON.parse(iData)); break;
    case 'mo': fDrawOpen    (iData, iMap)      ; break;
    case '/t': case '/f':                        break;
    default:  document.getElementById('get?'+i).innerText = iData;
    }
  };
  function fDrawPing(iList) {
    var aS = '';
    for (var a=0; a < iList.length; ++a) {
      var aArg = "'"+iList[a].Alias+"','"+(iList[a].Gid||'')+"'";
      aS += '<button onclick="mnm._PingDiscard('+aArg+')">Discard</button>';
      aS += '<button onclick="mnm._PingSend   ('+aArg+')">Send</button> \n';
      aS += JSON.stringify(iList[a]) + '\n';
    }
    document.getElementById('get?ps').innerHTML = aS;
  }
  function fDrawInvite(iList) {
    var aS = '';
    for (var a=0; a < iList.length; ++a) {
      if (!iList[a].Response)
        aS += '<button onclick="mnm.InviteAccept(\''+iList[a].Gid+'\')">Accept</button> \n';
      aS += JSON.stringify(iList[a]) + '\n';
    }
    document.getElementById('get?if').innerHTML = aS;
  }
  function fDrawThreads(iList) {
    var aS = '';
    for (var a=0; a < iList.length; ++a) {
      if (iList[a].Id.indexOf('/') < 0)
        aS += '<button onclick="mnm.ThreadGo(\''+iList[a].Id+'\')">Go</button> ';
      else
        aS += '<a href="?fn='+encodeURIComponent(iList[a].Id)+'" target="mnm_formtab">Open</a> ';
      aS += JSON.stringify(iList[a]) + '\n';
    }
    document.getElementById('get?tl').innerHTML = aS;
  }
  function fDrawAttached(iList) {
    var aS = '';
    for (var a=0; a < iList.length; ++a)
      aS += '<a href="?an='+encodeURIComponent(iList[a].File)+'" target="mnm_attach">'+
             JSON.stringify(iList[a])+'</a> ';
    document.getElementById('get?al').innerHTML = aS;
  }
  function fDrawTabs(iSt) {
    if (iSt.Thread !== 'none')
      document.getElementById('get?ct').innerHTML = fMakeTabs(iSt.ThreadTabs);
    document.getElementById('get?cs').innerHTML = fMakeTabs(iSt.SvcTabs);
  }
  function fMakeTabs(iTabs) {
    var aS = '';
    var aSet = [iTabs.Default, iTabs.Pinned, iTabs.Terms]
    for (var aI in aSet)
      if (aSet[aI])
        for (var a=0; a < aSet[aI].length; ++a)
          aS += '<button onclick="mnm._TabSelect('+iTabs.Type+','+aI+','+a+')">'+aSet[aI][a]+'</button>';
    aS +=       '<button onclick="mnm.TabDrop   ('+iTabs.Type+')" id="tabdrop'+iTabs.Type+'"'+
                       ' style="display:'+(iTabs.PosFor ? 'inline' : 'none')+'">X</button>';
    if (iTabs.Type === 1)
      aS +=     '<button onclick="mnm.TabPin    ('+iTabs.Type+')" id="tabpin'+iTabs.Type+'"'+
                       ' style="display:'+(iTabs.PosFor > 1 ? 'inline' : 'none')+'">T</button>';
    aS +=       '<button onclick="mnm._TabAdd   ('+iTabs.Type+')">Add</button>';
    return aS;
  }
  function fDrawMsgIndex(iList) {
    if (iList.length && iList[iList.length-1].Id !== sThread.id) {
      sThread = {id: iList[iList.length-1].Id, reply: {}};
      document.getElementById('get?mn').innerText = '';
      sData = 'you dont say';
    }
    var aS = '';
    for (var a=0; a < iList.length; ++a) {
      var aId = "'"+iList[a].Id+"'";
      aS += '<div>'+
        '<button onclick="mnm.ThreadOpen   ('+aId+')">O</button>'+
        '<button onclick="mnm.ThreadClose  ('+aId+')">X</button> ';
      if (iList[a].From !== '')
        aS +=
        '<button onclick="mnm._ThreadReply ('+aId+')">Reply</button>';
      else
        aS +=
        '<button onclick="mnm._Attach      ('+aId+')">Attach</button>'+
        '<button onclick="mnm._Blank       ('+aId+')">Blank</button>'+
        '<button onclick="mnm._Fill        ('+aId+')">Fill</button>'+
        '<button onclick="mnm._Drop        ('+aId+')">Drop</button> '+
        '<button onclick="mnm._Group       ('+aId+')">Group</button>'+
        '<button onclick="mnm._Text        ('+aId+')">Text</button>'+
        '<button onclick="mnm.ThreadSend   ('+aId+')">Send</button>'+
        '<button onclick="mnm.ThreadDiscard('+aId+')">Discard</button>';
      aS += '\n' + JSON.stringify(iList[a]) + '</div>\n';
    }
    document.getElementById('get?ml').innerHTML = aS;
  }
  function fDrawOpen(iText, iMap) {
    document.getElementById('get?mo').innerText = iText;
    sHeadMap = iMap;
  }

  var sHeadMap = null;
  var sLastFfn = null;
  var sThread = {id:null, reply:null};
  var sData = 'you dont say';

  if ('[{.Addr}]' === ':80') {
    var sNewAlias = 'Ninetynine', sAliasTo = 'Eightysix';
  } else {
    var sNewAlias = 'Eightysix', sAliasTo = 'Ninetynine';
  }

  mnm._SvcAdd = function() {
    mnm.SvcAdd({name:'take2', addr:'localhost:8888', alias:sNewAlias, loginperiod:0})
  };
  mnm._OhiAdd = function() {
    mnm.OhiAdd(sAliasTo)
  };
  mnm._OhiDrop = function() {
    mnm.OhiDrop(sAliasTo)
  };
  mnm._PingSave = function(i) {
    mnm.PingSave({alias:sNewAlias, to:sAliasTo, text:'ereiamjh', gid:i})
  };
  mnm._PingDiscard = function(iAlias, iGid) {
    mnm.PingDiscard({to:iAlias, gid:iGid})
  };
  mnm._PingSend = function(iAlias, iGid) {
    mnm.PingSend({to:iAlias, gid:iGid})
  };
  mnm._ThreadNew = function() {
    mnm.ThreadNew({data:'first msg', alias:sNewAlias, cc:[sAliasTo]})
  };
  mnm._ThreadReply = function(iOrig) {
    var aAtc = sHeadMap[iOrig].SubHead.Attach || [];
    for (var a=0; a < aAtc.length; ++a)
      if (aAtc[a].Ffn)
        sLastFfn = aAtc[a];
    mnm.ThreadReply({data:'orly?', alias:sNewAlias, cc:[sAliasTo]});
  };
  function fReply(i) {
    if (!sThread.reply[i])
      sThread.reply[i] = { data:'', attach:[], form_fill:{}, cc:[sAliasTo] };
    return sThread.reply[i];
  }
  function fSend(i) {
    mnm.ThreadSave({id:i, alias:sNewAlias, cc:[sAliasTo],
                    cc       : sThread.reply[i].cc,
                    data     : sThread.reply[i].data,
                    attach   : sThread.reply[i].attach,
                    formFill : sThread.reply[i].form_fill,
    });
  }
  mnm._Text = function(i) {
    fReply(i).data += '.';
    fSend(i);
  };
  mnm._Group = function(i) {
    fReply(i).cc = ['group[{.Addr}]'];
    fSend(i);
  };
  mnm._Attach = function(i) {
    fReply(i).attach.push({name:'upload/trial'});
    fSend(i);
  };
  mnm._Blank = function(i) {
    fReply(i).attach.push({name:'form/trial.original'});
    fSend(i);
  };
  mnm._Fill = function(i) {
    var aName = sLastFfn.Name.substr(2);
    fReply(i).form_fill[aName] = JSON.stringify({
      nr:1, so:'s', or:{ anr:[[1,2],[1,2]], aso:['s','s','s'] }});
    fReply(i).attach.push({name:'form_fill/'+aName, ffn:sLastFfn.Ffn});
    fSend(i);
  };
  mnm._Drop = function(i) {
    fReply(i).form_fill = {};
    fReply(i).attach = [];
    fSend(i);
  };
  mnm._TabAdd = function(iType) {
    mnm.TabAdd({type:iType, term:sData+='-'})
  };
  mnm._TabSelect = function(iType, iPosFor, iPos) {
    document.getElementById('tabdrop'+iType).style.display = iPosFor ? 'inline' : 'none';
    if (iType === 1)
      document.getElementById('tabpin'+iType).style.display = iPosFor > 1 ? 'inline' : 'none';
    mnm.TabSelect({type:iType, posfor:iPosFor, pos:iPos});
  };

  window.onload = mnm.Connect;

}).call(this);
</script>

</body></html>
