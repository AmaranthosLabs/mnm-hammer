<!DOCTYPE html>
<html><head>
<title>mnm - {{.Title}}</title>
</head><body>

<style>
.pre { font-family:monospace; white-space:pre-wrap; }
</style>

<p>
<form method="POST" action="/t/trial" enctype="multipart/form-data">
<a href="/web/service.html">get web file</a>
<input type="file" name="filename">
<input type="submit" value="upload">
<a href="/t/trial">download</a>
</form>
</p>

<div>
<button onclick="gM.SvcAdd()">Add Service</button>
</div>

<div>
<button onclick="gM.History(-1)">Back</button>
<button onclick="gM.History(1)">Next</button>
<button onclick="gM.Thread()">New Thread</button>
<button onclick="gM.Recv()">Receive Msg</button>
</div>

<table border="1">
<tr><td>services </td><td class="pre" id="get?s">.</td></tr>
<tr><td>threads  </td><td class="pre" id="get?t">.</td></tr>
<tr><td>tabs     </td><td class="pre" id="get?c">.</td></tr>
<tr><td>msg index</td><td class="pre" id="get?m">.</td></tr>
<tr><td>open msgs</td><td class="pre" id="get?o">.</td></tr>
<tr><td>last msg </td><td class="pre" id="get?p">.</td></tr>
</table>

<div id="stat"></div>
<div id="msg"></div>

<script>
;var gM = {};
(function() {
  function fDrawThreadTabs(iSt) {
    if (iSt.Thread === 'none')
      return;
    var aS =  '<button onclick="gM.SelectTab(0,0,0)">Opened</button>';
    aS +=     '<button onclick="gM.SelectTab(0,0,1)">All</button>';
    if (iSt.ThreadTabs.Terms) {
      var aList = iSt.ThreadTabs.Terms;
      for (var a=0; a < aList.length; ++a)
        aS += '<button onclick="gM.SelectTab(0,1,'+a+')">'+aList[a]+'</button>';
    }
    aS +=     '<button onclick="gM.DropTab  (0)" id="tabdrop">X</button>';
    aS +=     '<button onclick="gM.AddTab   (0,null)">Add</button>';
    document.getElementById('get?c').innerHTML = aS;
    document.getElementById('tabdrop').style.display = iSt.ThreadTabs.PosFor ? 'inline' : 'none';
  }
  function fDrawMsgIndex(iList) {
    sIdx = iList
    var aS = '';
    for (var a=0; a < iList.length; ++a) {
      var aId = "'"+iList[a].Id+"'";
      aS += '<div>'+
        '<button onclick="gM.Xhr(\'p\','+aId+')">O</button>'+
        '<button onclick="gM.Close('+aId+')"    >X</button> ';
      if (iList[a].Offset >= 0)
        aS +=
        '<button onclick="gM.Reply(\'\')"       >Reply</button>';
      else
        aS +=
        '<button onclick="gM.Reply('+aId+')"    >Save</button>'+
        '<button onclick="gM.Send('+aId+')"     >Send</button>'+
        '<button onclick="gM.Discard('+aId+')"  >Discard</button>';
      aS += '\n' + JSON.stringify(iList[a]) + '</div>\n';
    }
    document.getElementById('get?m').innerHTML = aS;
  }
  function fXhr(i, iP) {
    var aXhr = new XMLHttpRequest();
    aXhr.onload = function() {
      if (i === 'c')
        fDrawThreadTabs(JSON.parse(aXhr.responseText));
      else if (i === 'm')
        fDrawMsgIndex(JSON.parse(aXhr.responseText));
      else
        document.getElementById('get?'+i).innerText = aXhr.responseText;
    };
    aXhr.open('GET', '?'+i+(iP ? '='+iP : ''));
    aXhr.send();
  }

  var sWs = null;
  var sData='you dont say';
  var sIdx = null;

  gM.Xhr = fXhr;
  gM.SvcAdd = function() {
    sWs.send(JSON.stringify({op:'service_add', service:{
      name:'take2', addr:'localhost:8888', loginperiod:600}}))
  };
  gM.History = function(i) {
    sWs.send(JSON.stringify({op:'history', navigate:{history:i}}))
  };
  gM.Thread = function() {
    sWs.send(JSON.stringify({op:'thread_save', thread:{id:'', data:'start thread', new:true}}))
  };
  gM.Recv = function() {
    sWs.send(JSON.stringify({op:'thread_ohi', thread:{}}))
  };
  gM.Go = function(i) {
    sWs.send(JSON.stringify({op:'thread_set', thread:{id:i}}))
  };
  gM.Close = function(i) {
    sWs.send(JSON.stringify({op:'thread_close', thread:{id:i}}))
  };
  gM.Reply = function(i) {
    sWs.send(JSON.stringify({op:'thread_save', thread:{id:i, data:sData+='.'}}))
  };
  gM.Send = function(i) {
    sWs.send(JSON.stringify({op:'thread_send', thread:{id:i}}))
  };
  gM.Discard = function(i) {
    sWs.send(JSON.stringify({op:'thread_discard', thread:{id:i}}))
  };
  gM.AddTab = function(iId, iTerm) {
    sWs.send(JSON.stringify({op:'tab_add', tab:{threadid:iId, term:sData+='-'}}))
  };
  gM.SelectTab = function(iId, iPosFor, iPos) {
    document.getElementById('tabdrop').style.display = iPosFor ? 'inline' : 'none';
    sWs.send(JSON.stringify({op:'tab_select', tab:{threadid:iId, posfor:iPosFor, pos:iPos}}))
  };
  gM.DropTab = function(iId) {
    sWs.send(JSON.stringify({op:'tab_drop', tab:{threadid:iId}}))
  };

  window.onload = function() {
    var aSvc = window.location.pathname.split('/')[1];
    sWs = new WebSocket('ws://'+window.location.host+'/s/'+aSvc);
    sWs.onopen = function (iEvent) {
      fXhr('s'); fXhr('c'); fXhr('t'); fXhr('m'); fXhr('o');
    };
    sWs.onmessage = function (iEvent) {
      var aLog = document.getElementById('msg').innerText;
      document.getElementById('msg').innerText = iEvent.data+' '+aLog;
      var aObj = JSON.parse(iEvent.data);
      switch (aObj.op) {
      case 'service_add':
        fXhr('s');
        break;
      case 'delivery':
        fXhr('c'); fXhr('m'); fXhr('o'); fXhr('p', aObj.id);
        break;
      case 'ack':
        fXhr('m'); fXhr('o'); fXhr('p', aObj.id);
        sData = 'you dont say';
        if (sIdx.length === 1)
          document.getElementById('get?t').innerHTML +=
            '<button onclick="gM.Go(\''+aObj.id+'\')">'+aObj.id.slice(-5)+'</button>';
        break;
      case 'thread_save':
        fXhr('c'); fXhr('m'); fXhr('o'); fXhr('p', aObj.id);
        break;
      case 'thread_discard':
        fXhr('c'); fXhr('m'); fXhr('o');
        document.getElementById('get?p').innerText = '';
        break;
      case 'thread_close':
        fXhr('o');
        break;
      case 'thread_set':
      case 'history':
        fXhr('c'); fXhr('m'); fXhr('o');
        break;
      case 'tab_select':
        fXhr('o');
        break;
      case 'tab_add':
      case 'tab_drop':
        fXhr('c'); fXhr('o');
        break;
      }
    };
    sWs.onclose = function(iEvent) { document.getElementById('stat').innerText = 'closed' };
    sWs.onerror = function(iEvent) { document.getElementById('stat').innerText = iEvent.data };
  };
}).call(this);
</script>

</body></html>
